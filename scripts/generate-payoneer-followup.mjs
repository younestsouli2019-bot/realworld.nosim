import 'dotenv/config'
import fs from 'fs'
import path from 'path'

function parseArgs(argv) {
  const args = {}
  for (let i = 2; i < argv.length; i++) {
    const a = argv[i]
    if (!a.startsWith('--')) continue
    const k = a.slice(2)
    const v = argv[i + 1] && !argv[i + 1].startsWith('--') ? argv[i + 1] : true
    args[k] = v
    if (v !== true) i++
  }
  return args
}

function findAttachmentByRef(ref) {
  const root = process.cwd()
  const out = []
  function walk(dir) {
    const entries = fs.readdirSync(dir, { withFileTypes: true })
    for (const e of entries) {
      const p = path.join(dir, e.name)
      if (e.isDirectory()) {
        if (e.name === 'node_modules' || e.name.startsWith('.git')) continue
        walk(p)
      } else {
        const name = e.name.toLowerCase()
        if (name.endsWith('.txt') && name.includes(String(ref).toLowerCase())) out.push(p)
      }
    }
  }
  walk(root)
  return out[0] || ''
}

function buildEmail({ requestorName, requestorEmail, accountId, amountUsd, batchRef, purpose, reference, note }) {
  const lines = []
  lines.push(`From: ${requestorName} <${requestorEmail}>`)
  lines.push(`To: customersupport@payoneer.com`)
  lines.push(`Subject: Inquiry Regarding Held Funds - Ref: ${batchRef}`)
  lines.push(``)
  lines.push(`Dear Payoneer Support,`)
  lines.push(``)
  lines.push(`I am writing to inquire about a pending balance of $${amountUsd} USD from my digital services aggregator.`)
  lines.push(`The system indicates these funds are currently "Held by Platform" in my Global Payment Service receiving account.`)
  lines.push(``)
  lines.push(`Details:`)
  lines.push(`- Account ID: ${accountId}`)
  lines.push(`- Amount: $${amountUsd} USD`)
  lines.push(`- Reference ID: ${batchRef}`)
  lines.push(`- Source: Swarm Autonomous Revenue Aggregator (Global Payment Service)`)
  lines.push(`- Status: PENDING / HELD BY PLATFORM`)
  lines.push(`- Service Description: ${purpose}`)
  if (reference) lines.push(`- Invoice/Reference: ${reference}`)
  lines.push(``)
  lines.push(`I have attached the Payment Remittance Advice generated by the source platform for your reference.`)
  lines.push(`Please confirm when these funds will be released to my available balance for withdrawal.`)
  lines.push(``)
  lines.push(`Best regards,`)
  lines.push(`${requestorName}`)
  if (note) {
    lines.push(``)
    lines.push(`Note: ${note}`)
  }
  return `${lines.join('\n')}\n`
}

async function main() {
  const args = parseArgs(process.argv)
  const batchRef = String(args.batch || args.batch_ref || args.ref || '').trim() || 'BATCH_PAYONEER_X_1767529200'
  const amountUsd = String(args.amount || process.env.SETTLEMENT_AMOUNT_USD || '1200').trim()
  const requestorName = process.env.SETTLEMENT_REQUESTOR_NAME || 'Owner'
  const requestorEmail = process.env.SETTLEMENT_REQUESTOR_EMAIL || process.env.OWNER_PAYONEER_EMAIL || process.env.OWNER_PAYPAL_EMAIL || ''
  const accountId = process.env.OWNER_PAYONEER_ID || ''
  const purpose = process.env.SETTLEMENT_PURPOSE || 'Digital Software Development Services'
  const reference = process.env.SETTLEMENT_REFERENCE || ''
  const note = process.env.SETTLEMENT_NOTE || ''

  const attachmentArg = args.attachment || args.attach || ''
  const attachmentPath = String(attachmentArg || findAttachmentByRef(batchRef))

  const emailText = buildEmail({ requestorName, requestorEmail, accountId, amountUsd, batchRef, purpose, reference, note })
  const outDir = path.resolve('exports/communications')
  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true })
  const ts = Date.now()
  const txtPath = path.join(outDir, `payoneer_followup_${batchRef}_${ts}.txt`)
  const jsonPath = path.join(outDir, `payoneer_followup_${batchRef}_${ts}.json`)
  fs.writeFileSync(txtPath, emailText, 'utf8')
  const payload = {
    to: 'customersupport@payoneer.com',
    subject: `Inquiry Regarding Held Funds - Ref: ${batchRef}`,
    from_name: requestorName,
    from_email: requestorEmail,
    account_id: accountId,
    amount_usd: Number(amountUsd),
    batch_ref: batchRef,
    purpose,
    reference,
    note,
    attachment_path: attachmentPath || null
  }
  fs.writeFileSync(jsonPath, JSON.stringify(payload, null, 2))
  console.log(JSON.stringify({ ok: true, txt: txtPath, json: jsonPath, attachment: attachmentPath }, null, 2))
}

main()
